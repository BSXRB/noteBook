# 对象的创建

## 对象的创建过程

当java虚拟机遇到一条字节码new指令时，首先检查这个指令的参数是否能在常量池中定位到一个类的符号引用，若这个类没有被加载，解析和初始话过，就必须先执行该类的加载。

再通过类加载检查后，虚拟机会为新对象分配内存，具体内存大小及布局在下一节将会讲到，至于具体分配到堆中哪一块内存，是使用指针碰撞还是空闲列表的方式，取决于选用的GC算法，在以后GC篇详细讲解。

再分配内存时有个还存在线程安全问题。针对这个问题虚拟机有两种可选择的方案，

1. CAS+失败重试。 CAS操作在虚拟机中频繁被使用，CAS是一种无锁的解决并发线程安全问题的方案。
2. 为每个线程分配缓冲区，（TLAB thread local allocation buffer） 当线程需要而非你陪内存时率先使用TLAB，当TLAB使用完之后，重新分配新的TLAB之前才需要同步操作。



## 对象的内存布局

对象内存布局可以分为三个部分 对象头、实例数据、对齐填充。

对象头的第一部分被称为mark word，包括对象哈希码、对象分代年龄、指向锁记录的指针等。

第二部分是类型指针。该指针指向的是他的类型元数据的指针，通过这个指针可以判断该对象属于哪个类，不过不同虚拟机有不同的实现，并不是所有虚拟机都有这部分内存。

实例数据部分就是我们定义的对象中的字段内容，无论是父类的还是自己的都会被记录下来。

对其填充，占位符，当对象内存不是8的倍数时填充使用。

## 对象的访问

当我们要引用创建好的对象，通常是通过栈上的reference来找到堆中具体的对象的，通常的访问方式有两种：

1. 句柄访问。当使用句柄访问时，堆内存会分配出一块空间用于存放对象的句柄，句柄中存有对象的实例数据指针和类型数据指针。而栈上的引用地址就是句柄地址。

   

2. 直接指针访问。栈上的引用地址就是对象在堆山上的直接地址，这是对象本身就要存上他的类型信息。