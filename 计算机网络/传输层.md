# 传输层

传输层不同于之前三层的最主要在于只有主机的协议栈才有运输层，而网络核心部分中的路由器在转发分组都只用到下面三层的功能，我们常用到的网络通信实际上是进程到进程间的通信。

传输层向高层用户屏蔽了下面网络核心的细节(如网络拓扑，所使用的路由协议等)。它使引用进程看见的就是好像两个传输层实体之间的一条端到端的逻辑通信信道。这条信道使用不同的协议会存在很大的差别如当采用面向连接的TCP协议时，尽管下面的网络时不可靠的，但这逻辑通信信道仍然相当于一条双颧弓的可靠信道，当传输层采用无连接的UDP协议时，这条信道就是一条不可靠的信道。

![image-20200824215846664](D:\Note\img\常见的引用层对应的传输层协议.png)

传输层还承担**复用**和**分用**的职责，即应用进程都可以通过传输层传送到IP：层，这就是复用。传输层从IP层收到发送给各个进程的数据后必须正确的交付，这就是分用。因此需要给每个引用进程赋予一个标志，这就是我们常说的端口。

端口号由16位组成所以一台主机最多有65535个不同的端口号，不同端口号又分为

1. 服务端使用的端口号其中1~1023被称为熟知端口号或者系统端口号，对应了一些重要的应用程序。还有一种称为等级端口号，数值为1024~49151该类端口是为了没有熟知端口号的应用程序使用的，使用这些端口号必须在IANA上登记，以防重复。

![image-20200824220915755](D:\Note\img\熟知端口号.png)

2. 客户端使用端口号 数值为49452~65535又被称为短暂端口号，这类端口号是留给客户端和服务端通信时用的，分配端口号，建立连接。当连接断开后该端口号会被回收等待下次分配。

## UDP

用户数据报协议(UDP)该协议只是在IP数据报服务上增加了很少的一部分功能，主要就是复用，分用以及差错检测。UDP的主要特点如下

1. 无连接 即发送数据之前不需要建立连接
2. 尽最大努力交付 即不保证信息交付的可靠性
3. 面向报文 即不对应用层的报文进行分割或者合并。所以当使用UDP协议的应用应该控制报文长度避免过长导致在IP层时分片，降低IP层效率，也不能过短导致IP层头部相对数据部分太长，降低了传输效率。
4. 没有拥塞控制 不会因为网络拥塞控制源主机发送数据的效率，这对一些要求低延时，又对少量数据丢失不敏感的应用非常重要，如(IP电话，视频会议等)
5. 支持一对一、一对多、多对一、多对多等。
6. 首部开销小 只有8个字节相对与TCP20个字节来说短的多。当然也因为实现的功能少。

#### UDP首部

UDP首部由四个部分组成每个部分两个字节：

1. 源端口号 需要对方回信时使用，不用时可以全0
2. 目的端口号 目的方的端口号，必须有
3. 长度 UDP用户数据报的长度，最小值为8
4. 校验和 检测用户数据报在传输过程中是否有错，出错就抛弃

![image-20200824222556106](D:\Note\img\UDP头部.png)

其中有12字节的伪首部，该部分不会向引用层或者IP层提交，只在计算校验和时临时添加在用户数据报上的。具体计算方式如下：

![image-20200824222847238](D:\Note\img\UDP校验和计算.png)



## TCP

TCP相对于UDP复杂得多主要特点包括

1. 面向连接
2. 只有两个端点，也就是TCP只能一对一
3. TCP提供可靠交付，可靠的意思是指，无差错、不丢失、不重复，并且按序到达。
4. 双全工信道，在连接是双方可以在任何时候进行通信，双方各有发送缓存和接收缓存。
5. 面向字节流，意思是指TCP只负责将字节流可靠的交付给对方，可能发送方发了十个数据包，接收方只用四个数据包就把数据交付给了应用层，但是其中的字节流是可靠的。

tcp是面向连接的，有两个端点的，这两个端口被称为套接字(socket) 即将端口号和ip地址拼接到一起。如(192.16.5.1:80)一条TCP连接被唯一地两端套接字确定。

### TCP可靠传输原理

我们知道无论是IP层还是数据链路层还是物理层都是不可靠的，因此TCP必须要添加很多额外的控制手段才能使得两个端点之间的传输变得可靠。这面临两个问题

1. 传输信道不能产生差错
2. 不管发送方发送的数据多块，接收方都来得及接受。

实际上这两点是很难达到的，要控制这两天主要有两种手段：1.当发现数据差错时要提醒发送方重传，2.当接收方来不及接受时要提醒发送方降低发送速率。

#### 停止等待协议

停止等待协议简单来说就是发送方A每次只发送一个分组，接收方B接到分组后回一个确认，A会在收到确认后发送第二个分组。

当出现差错时，比如A发送了一个分组在很长时间都没有收到确认，那么A就可以假定发送的分组丢失了，就会重新发送一个分组，这叫超时重传，在接收到分组后会重置计时器，这个时间一般会比一个RTT长一点。

当然第一个分组也一定是丢失了，也可能是网络拥塞导致延时到达或者B发送的确认拥塞了延迟到达，对于这种情况

B收到重复分组后直接丢去不交给上层应用，同时向A发送确认。A若是收到了重复确认也直接丢弃，继续向下发送报文段。

为了实现这个功能必须：

1.保留已发送的副本，防止超时重传

2.对已发送的分组进行编号，这样可以确认哪些分组是收到确认的，哪些是没有的。



![image-20200824230813929](D:\Note\img\停止等待协议(1).png)

![image-20200824230940035](D:\Note\img\停止等待协议(2).png)

上图描述了两种差错在停止等待协议下的情况。

很明显每次只发送一个报文段对信道的利用率是非常低的，因此除了停止等待协议外可以使用流水线传输，即每次发送多个报文段，当使用流水线传输时使用**连续ARQ协议**和**滑动窗口协议**



#### 连续ARQ协议

![image-20200824231541817](D:\Note\img\连续ARQ协议.png)

如图所示 连续ARQ协议指的是一次可以按顺序连续发送窗口内的5个报文段，当收到接收方确认后可以继续向前滑动，比如图中收到一个确认后就向前滑动一位那么第六个报文段就可以发送了。当然这会有一些问题，当信道质量比较好的时候该方式可以大大提高效率，但是假设如图中所示，若中间第三个分组丢失了接收方只对前两个分组发出了确认，发送方无法知道后面三个报文段是否都到达了，就要回退三个，将三个报文段都重传一次，这更影响信道的利用率。

### TCP报文段首部格式